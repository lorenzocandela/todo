<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>to-do</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        * { font-family: 'Fira Code', monospace; }
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        editor: {
                            bg: '#1e1e1e',
                            sidebar: '#252526',
                            line: '#2d2d2d',
                            border: '#3e3e3e',
                            text: '#d4d4d4',
                            muted: '#6e6e6e',
                            comment: '#6a9955',
                            keyword: '#569cd6',
                            string: '#ce9178',
                            number: '#b5cea8',
                            func: '#dcdcaa',
                            var: '#9cdcfe',
                            type: '#4ec9b0',
                            orange: '#ce9178',
                            purple: '#c586c0',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-editor-bg text-editor-text min-h-screen text-sm">
    <div id="app" class="max-w-3xl mx-auto">
        <div class="flex items-center bg-editor-sidebar border-b border-editor-border px-2">
            <div class="flex items-center gap-2 px-4 py-2 bg-editor-bg border-t-2 border-editor-keyword text-editor-text">
                <span>to-do</span>
            </div>
            <div class="ml-auto flex items-center gap-1 py-2">
                <button @click="addToday" class="px-2 py-1 hover:bg-editor-line rounded text-editor-muted hover:text-editor-text text-xs">+ oggi</button>
                <button @click="carryOverTasks" class="px-2 py-1 hover:bg-editor-line rounded text-editor-muted hover:text-editor-text text-xs">↓ pendenti</button>
                <button @click="exportData" class="px-2 py-1 hover:bg-editor-line rounded text-editor-muted hover:text-editor-text text-xs">export</button>
                <button @click="importData" class="px-2 py-1 hover:bg-editor-line rounded text-editor-muted hover:text-editor-text text-xs">import</button>
            </div>
        </div>
        <div class="flex">
            <div class="bg-editor-bg text-editor-muted text-right py-4 select-none w-12 border-r border-editor-border">
                <div v-for="n in totalLines" :key="n" class="px-3 leading-6">{{ n }}</div>
            </div>
            <div class="flex-1 py-4 pl-4 pr-2">
                
                <template v-for="(day, dayIndex) in days" :key="day.date">
                    <div class="leading-6 flex items-center group">
                        <span class="text-editor-comment"># </span>
                        <span class="text-editor-keyword font-medium">{{ day.date }}</span>
                        <span class="text-editor-muted ml-4 text-xs">({{ day.tasks.filter(t => t.done).length }}/{{ day.tasks.length }})</span>
                        <button @click="removeDay(dayIndex)" class="ml-2 text-editor-muted hover:text-red-400 opacity-0 group-hover:opacity-100 text-xs">✕</button>
                    </div>

                    <div v-for="(task, taskIndex) in day.tasks" :key="taskIndex" class="leading-6 flex items-center group hover:bg-editor-line/50 -mx-4 px-4">
                        <button @click="toggleTask(dayIndex, taskIndex)" class="mr-1">
                            <span v-if="task.done" class="text-editor-comment">[x]</span>
                            <span v-else class="text-editor-muted">[ ]</span>
                        </button>
                        <input v-model="task.text" @blur="save" :class="task.done ? 'text-editor-muted line-through' : 'text-editor-string'" class="bg-transparent flex-1 outline-none" placeholder="...">
                        <button @click="removeTask(dayIndex, taskIndex)" class="text-editor-muted hover:text-red-400 opacity-0 group-hover:opacity-100 text-xs ml-2">✕</button>
                    </div>

                    <div class="leading-6 flex items-center text-editor-muted -mx-4 px-4 hover:bg-editor-line/50">
                        <span class="mr-1">[ ]</span>
                        <input @keyup.enter="addTask(dayIndex, $event)" class="bg-transparent flex-1 outline-none placeholder-editor-muted/50" placeholder="...">
                    </div>

                    <div class="leading-6">&nbsp;</div>
                </template>

                <div class="leading-6">
                    <span class="text-editor-comment"># </span>
                    <span class="text-editor-purple font-medium">note flash</span>
                </div>
                
                <div v-for="(note, index) in notes" :key="'note-'+index" class="leading-6 flex items-center group hover:bg-editor-line/50 -mx-4 px-4">
                    <span class="text-editor-muted mr-1">-</span>
                    <input v-model="notes[index]" @blur="save" class="bg-transparent flex-1 outline-none text-editor-orange" placeholder="...">
                    <button @click="removeNote(index)" class="text-editor-muted hover:text-red-400 opacity-0 group-hover:opacity-100 text-xs ml-2">✕</button>
                </div>

                <div class="leading-6 flex items-center text-editor-muted -mx-4 px-4 hover:bg-editor-line/50">
                    <span class="mr-1">-</span>
                    <input @keyup.enter="addNote($event)" class="bg-transparent flex-1 outline-none placeholder-editor-muted/50" placeholder="...">
                </div>
            </div>
        </div>
        <div class="fixed bottom-0 left-0 right-0 bg-editor-keyword/80 text-white text-xs flex items-center justify-between px-4 py-1">
            <div class="flex items-center gap-4">
                <span>{{ totalPending }} pendenti</span>
                <span>{{ days.length }} giorni</span>
            </div>
            <div class="flex items-center gap-4">
                <span>{{ currentDateTime }}</span>
            </div>
        </div>
        <div class="h-8"></div>
        <input type="file" ref="fileInput" @change="handleImport" class="hidden" accept=".json">
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('SW registered'))
                .catch((err) => console.log('SW failed:', err));
        }

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
        setup() {
            const days = ref([]);
            const notes = ref([]);
            const fileInput = ref(null);

            const currentDateTime = computed(() => {
                const now = new Date();
                return now.toLocaleDateString('it-IT') + ' ' + now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            });

            const totalPending = computed(() => {
                return days.value.reduce((acc, day) => acc + day.tasks.filter(t => !t.done && t.text.trim()).length, 0);
            });

            const totalLines = computed(() => {
                let count = 0;
                days.value.forEach(day => {
                    count += 1 + day.tasks.length + 2;
                });
                count += 1 + notes.value.length + 1;
                return Math.max(count, 20);
            });

            const formatDate = (date) => {
                const d = date.getDate().toString().padStart(2, '0');
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                return `${d}/${m}`;
            };

            const parseDate = (dateStr) => {
                const [d, m] = dateStr.split('/').map(Number);
                const year = new Date().getFullYear();
                const currentMonth = new Date().getMonth() + 1;
                const adjustedYear = m > currentMonth + 1 ? year - 1 : year;
                return new Date(adjustedYear, m - 1, d);
            };

            const sortDays = () => {
                days.value.sort((a, b) => parseDate(b.date) - parseDate(a.date));
            };

            const save = () => {
                localStorage.setItem('dailyTasks', JSON.stringify({ days: days.value, notes: notes.value }));
            };

            const load = () => {
                const data = localStorage.getItem('dailyTasks');
                if (data) {
                    const parsed = JSON.parse(data);
                    days.value = parsed.days || [];
                    notes.value = parsed.notes || [];
                    sortDays();
                }
            };

            const addToday = () => {
                const today = formatDate(new Date());
                if (!days.value.find(d => d.date === today)) {
                    days.value.unshift({ date: today, tasks: [] });
                    sortDays();
                    save();
                }
            };

            const addTask = (dayIndex, event) => {
                const text = event.target.value.trim();
                if (text) {
                    days.value[dayIndex].tasks.push({ text, done: false });
                    event.target.value = '';
                    save();
                }
            };

            const toggleTask = (dayIndex, taskIndex) => {
                days.value[dayIndex].tasks[taskIndex].done = !days.value[dayIndex].tasks[taskIndex].done;
                save();
            };

            const removeTask = (dayIndex, taskIndex) => {
                days.value[dayIndex].tasks.splice(taskIndex, 1);
                save();
            };

            const removeDay = (dayIndex) => {
                if (confirm('Eliminare questo giorno?')) {
                    days.value.splice(dayIndex, 1);
                    save();
                }
            };

            const carryOverTasks = () => {
                const today = formatDate(new Date());
                let todayDay = days.value.find(d => d.date === today);
                
                if (!todayDay) {
                    days.value.unshift({ date: today, tasks: [] });
                    sortDays();
                    todayDay = days.value.find(d => d.date === today);
                }

                let carried = 0;
                days.value.forEach((day) => {
                    if (day.date !== today) {
                        const pending = day.tasks.filter(t => !t.done && t.text.trim());
                        pending.forEach(t => {
                            if (!todayDay.tasks.find(tt => tt.text === t.text)) {
                                todayDay.tasks.push({ ...t });
                                carried++;
                            }
                        });
                    }
                });

                alert(carried > 0 ? `${carried} task portati a oggi` : 'Nessun task pendente');
                save();
            };

            const addNote = (event) => {
                const text = event.target.value.trim();
                if (text) {
                    notes.value.unshift(text);
                    event.target.value = '';
                    save();
                }
            };

            const removeNote = (index) => {
                notes.value.splice(index, 1);
                save();
            };

            const exportData = () => {
                const data = JSON.stringify({ days: days.value, notes: notes.value }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tasks-${formatDate(new Date()).replace('/', '-')}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const importData = () => fileInput.value.click();

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.days) days.value = data.days;
                            if (data.notes) notes.value = data.notes;
                            sortDays();
                            save();
                            alert('Import completato');
                        } catch (err) {
                            alert('Errore nel file JSON');
                        }
                    };
                    reader.readAsText(file);
                }
                event.target.value = '';
            };

            onMounted(load);

            return {
                days, notes, currentDateTime, totalPending, totalLines, fileInput, save,
                addToday, addTask, toggleTask, removeTask, removeDay, carryOverTasks,
                addNote, removeNote, exportData, importData, handleImport
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
