<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>to-do</title>
        <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
            * { font-family: 'Fira Code', monospace; }
            ::-webkit-scrollbar { display: none; }
            * { -ms-overflow-style: none; scrollbar-width: none; }
            input::placeholder, textarea::placeholder { color: #6e6e6e !important; opacity: 0.6; }
            .profilo { cursor: pointer !important; transition: all .5s ease; }
            .profilo:hover { border: solid 1px #ffffff8c !important; opacity: .8;}
        </style>
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="data:,">
        <meta name="theme-color" content="#1e1e1e">
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            editor: {
                                bg: '#1e1e1e',
                                sidebar: '#252526',
                                line: '#2d2d2d',
                                border: '#3e3e3e',
                                text: '#d4d4d4',
                                muted: '#6e6e6e',
                                comment: '#6a9955',
                                keyword: '#569cd6',
                                string: '#ce9178',
                                number: '#b5cea8',
                                func: '#dcdcaa',
                                var: '#9cdcfe',
                                type: '#4ec9b0',
                                orange: '#ce9178',
                                purple: '#c586c0',
                            }
                        }
                    }
                }
            }
        </script>
    </head>
    <body class="bg-editor-bg text-editor-text min-h-screen text-sm">
        <div id="app" class="max-w-3xl mx-auto">
            <div v-if="!user && !guestMode && !loading" class="min-h-screen flex items-center justify-center">
                <div class="bg-editor-sidebar border border-editor-border rounded-lg p-8 w-full max-w-md">
                    <div class="text-center mb-8">
                        <div class="text-2xl font-medium text-editor-keyword mb-2">to-do</div>
                        <div class="text-editor-muted text-xs">Accedi per salvare le tue task</div>
                    </div>

                    <button @click="loginWithGoogle" :disabled="authLoading" 
                        class="w-full flex items-center justify-center gap-3 bg-white text-gray-800 py-3 px-4 rounded-lg hover:bg-gray-100 transition mb-4 disabled:opacity-50">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span class="font-medium">Continua con Google</span>
                    </button>

                    <div class="flex items-center gap-4 my-6">
                        <div class="flex-1 border-t border-editor-border"></div>
                        <span class="text-editor-muted text-xs">oppure</span>
                        <div class="flex-1 border-t border-editor-border"></div>
                    </div>

                    <div v-if="!emailSent">
                        <div class="mb-4">
                            <label class="text-editor-muted text-xs block mb-2">Email</label>
                            <input v-model="email" type="email" placeholder="tu@email.com"
                                class="w-full bg-editor-bg border border-editor-border rounded-lg px-4 py-3 text-editor-text outline-none focus:border-editor-keyword transition"
                                @keyup.enter="sendEmailLink">
                        </div>
                        <button @click="sendEmailLink" :disabled="authLoading || !email"
                            class="w-full bg-editor-keyword text-white py-3 px-4 rounded-lg hover:bg-editor-keyword/80 transition disabled:opacity-50">
                            {{ authLoading ? 'Invio...' : 'Ricevi link di accesso' }}
                        </button>
                    </div>

                    <div v-else class="text-center">
                        <div class="text-editor-comment text-4xl mb-4">✓</div>
                        <div class="text-editor-text mb-2">Link inviato!</div>
                        <div class="text-editor-muted text-xs mb-4">Controlla la tua email e clicca il link per accedere</div>
                        <button @click="emailSent = false" class="text-editor-keyword text-xs hover:underline">
                            Invia di nuovo
                        </button>
                    </div>

                    <div class="flex items-center gap-4 my-6">
                        <div class="flex-1 border-t border-editor-border"></div>
                        <span class="text-editor-muted text-xs">oppure</span>
                        <div class="flex-1 border-t border-editor-border"></div>
                    </div>

                    <button @click="enterGuestMode"
                        class="w-full bg-editor-line text-editor-text py-3 px-4 rounded-lg hover:bg-editor-border transition">
                        <span class="font-medium">Continua come ospite</span>
                    </button>

                    <div v-if="authError" class="mt-4 text-red-400 text-xs text-center">{{ authError }}</div>
                </div>
            </div>

            <div v-if="loading" class="min-h-screen flex items-center justify-center">
                <div class="text-editor-muted">Caricamento...</div>
            </div>

            <template v-if="user || guestMode">
                <!-- header -->
                <div class="flex items-center bg-editor-sidebar border-b border-editor-border px-2">
                    <div class="flex items-center gap-2 px-4 py-2 bg-editor-bg border-t-2 border-editor-keyword text-editor-text">
                        <span>to-do</span>
                    </div>
                    <div class="ml-auto flex items-center gap-1 py-2">
                        <button @click="addToday" class="px-2 py-1 hover:bg-editor-line rounded text-editor-muted hover:text-editor-text text-xs">+ oggi</button>
                        <button @click="carryOverTasks" class="px-2 py-1 hover:bg-editor-line rounded text-editor-muted hover:text-editor-text text-xs">↓ pendenti</button>
                        <button @click="exportData" class="px-2 py-1 hover:bg-editor-line rounded text-editor-muted hover:text-editor-text text-xs">export</button>
                        <button @click="importData" class="px-2 py-1 hover:bg-editor-line rounded text-editor-muted hover:text-editor-text text-xs">import</button>
                        <div class="w-px h-4 bg-editor-border mx-1"></div>
                        <div class="flex items-center gap-2 px-2">
                            <div v-if="guestMode" class="flex items-center gap-2">
                                <span class="text-editor-orange text-xs">ospite</span>
                                <button @click="exitGuestMode" class="text-editor-muted hover:text-editor-text text-xs">accedi</button>
                            </div>
                            <div v-else class="flex items-center gap-2">
                                <div @click="settingsModal.show = true" style="cursor: pointer !important;" class="profilo w-6 h-6 rounded-full bg-editor-keyword flex items-center justify-center text-xs text-white">
                                    {{ user.email?.charAt(0).toUpperCase() }}
                                </div>
                                <button @click="logout" class="text-editor-muted hover:text-editor-text text-xs">esci</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- main -->
                <div class="flex">
                    <div class="bg-editor-bg text-editor-muted text-right py-4 select-none w-12 border-r border-editor-border">
                        <div v-for="n in totalLines" :key="n" class="px-3 leading-6">{{ n }}</div>
                    </div>
                    <div class="flex-1 py-4 pl-4 pr-2">
                        
                        <template v-for="(day, dayIndex) in days" :key="day.date">
                            <div class="leading-6 flex items-center group">
                                <span class="text-editor-comment"># </span>
                                <span class="text-editor-keyword font-medium">{{ day.date }}</span>
                                <span class="text-editor-muted ml-4 text-xs">({{ day.tasks.filter(t => t.done).length }}/{{ day.tasks.length }})</span>
                                <button @click="removeDay(dayIndex)" class="ml-2 text-editor-muted hover:text-red-400 opacity-0 group-hover:opacity-100 text-xs">✕</button>
                            </div>

                            <div v-for="(task, taskIndex) in day.tasks" :key="taskIndex" class="leading-6 flex items-center group hover:bg-editor-line/50 -mx-4 px-4">
                                <button @click="toggleTask(dayIndex, taskIndex)" class="mr-1">
                                    <span v-if="task.done" class="text-editor-comment">[x]</span>
                                    <span v-else class="text-editor-muted">[ ]</span>
                                </button>
                                <input v-model="task.text" @blur="save" :class="task.done ? 'text-editor-muted line-through' : 'text-editor-string'" class="bg-transparent flex-1 outline-none" placeholder="...">
                                <button @click="openDetails(dayIndex, taskIndex)" class="text-editor-muted hover:text-editor-keyword opacity-0 group-hover:opacity-100 text-xs ml-2" :class="{ 'text-editor-keyword opacity-100': task.details }">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                                    </svg>
                                </button>
                                <button @click="removeTask(dayIndex, taskIndex)" class="text-editor-muted hover:text-red-400 opacity-0 group-hover:opacity-100 text-xs ml-1">✕</button>
                            </div>

                            <div class="leading-6 flex items-center text-editor-muted -mx-4 px-4 hover:bg-editor-line/50">
                                <span class="mr-1">[ ]</span>
                                <input @keyup.enter="addTask(dayIndex, $event)" class="bg-transparent flex-1 outline-none" placeholder="...">
                            </div>

                            <div class="leading-6">&nbsp;</div>
                        </template>

                        <div class="leading-6">
                            <span class="text-editor-comment"># </span>
                            <span class="text-editor-purple font-medium">note flash</span>
                        </div>
                        
                        <div v-for="(note, index) in notes" :key="'note-'+index" class="leading-6 flex items-center group hover:bg-editor-line/50 -mx-4 px-4">
                            <span class="text-editor-muted mr-1">-</span>
                            <input v-model="notes[index]" @blur="save" class="bg-transparent flex-1 outline-none text-editor-orange" placeholder="...">
                            <button @click="removeNote(index)" class="text-editor-muted hover:text-red-400 opacity-0 group-hover:opacity-100 text-xs ml-2">✕</button>
                        </div>

                        <div class="leading-6 flex items-center text-editor-muted -mx-4 px-4 hover:bg-editor-line/50">
                            <span class="mr-1">-</span>
                            <input @keyup.enter="addNote($event)" class="bg-transparent flex-1 outline-none" placeholder="...">
                        </div>
                    </div>
                </div>

                <!-- footer -->
                <div class="fixed bottom-0 left-0 right-0 text-white text-xs flex items-center justify-between px-4 py-1" :class="guestMode ? 'bg-editor-orange/80' : 'bg-editor-keyword/80'">
                    <div class="flex items-center gap-4">
                        <span>{{ totalPending }} pendenti</span>
                        <span>{{ days.length }} giorni</span>
                        <span v-if="guestMode" class="text-white/70">modalità ospite</span>
                        <span v-else-if="syncing" class="text-editor-func">sincronizzando...</span>
                        <span v-else class="text-editor-comment">✓ sync</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span>{{ currentDateTime }}</span>
                    </div>
                </div>
                <div class="h-8"></div>
                <input type="file" ref="fileInput" @change="handleImport" class="hidden" accept=".json">

                <!-- info task -->
                <div v-if="detailsModal.show" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="closeDetails">
                    <div class="bg-editor-sidebar border border-editor-border rounded-lg w-full max-w-lg">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-editor-border">
                            <div class="flex items-center gap-2">
                                <span class="text-editor-comment">//</span>
                                <span class="text-editor-text text-xs truncate max-w-xs">{{ detailsModal.task?.text }}</span>
                            </div>
                            <button @click="closeDetails" class="text-editor-muted hover:text-editor-text">✕</button>
                        </div>
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-editor-muted text-xs">Dettagli</label>
                                <button @click="generateWithAI" :disabled="aiLoading || !openaiKey" class="flex items-center gap-1 px-2 py-1 text-xs rounded bg-editor-line hover:bg-editor-border text-editor-purple disabled:opacity-50" :title="!openaiKey ? 'configura key' : ''">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                    {{ aiLoading ? 'generando...' : 'genera con AI' }}
                                </button>
                            </div>
                            <textarea 
                                v-model="detailsModal.details" 
                                class="w-full bg-editor-bg border border-editor-border rounded-lg px-3 py-2 text-editor-text outline-none focus:border-editor-keyword transition resize-none text-xs"
                                rows="6"
                                placeholder="Aggiungi dettagli, note, link..."
                            ></textarea>
                            <div v-if="!openaiKey" class="text-editor-muted text-xs mt-2">
                                <i>per AI configura l'API key, cliccando sull'icona del profilo</i>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2 px-4 py-3 border-t border-editor-border">
                            <button @click="closeDetails" class="px-4 py-2 text-editor-muted hover:text-editor-text text-xs">Annulla</button>
                            <button @click="saveDetails" class="px-4 py-2 bg-editor-keyword text-white rounded text-xs hover:bg-editor-keyword/80">Salva</button>
                        </div>
                    </div>
                </div>

                <!-- settings -->
                <div v-if="settingsModal.show" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="settingsModal.show = false">
                    <div class="bg-editor-sidebar border border-editor-border rounded-lg w-full max-w-md">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-editor-border">
                            <span class="text-editor-text text-xs">⚙ Impostazioni</span>
                            <button @click="settingsModal.show = false" class="text-editor-muted hover:text-editor-text">✕</button>
                        </div>
                        <div class="p-4">
                            <label class="text-editor-muted text-xs block mb-2">OpenAI API Key</label>
                            <input 
                                v-model="settingsModal.apiKey" 
                                type="password"
                                class="w-full bg-editor-bg border border-editor-border rounded-lg px-3 py-2 text-editor-text outline-none focus:border-editor-keyword transition text-xs"
                                placeholder="sk-..."
                            >
                            <div class="text-editor-muted text-xs mt-2">
                                la key viene salvata solo nel tuo browser
                            </div>
                        </div>
                        <div class="flex justify-end gap-2 px-4 py-3 border-t border-editor-border">
                            <button @click="settingsModal.show = false" class="px-4 py-2 text-editor-muted hover:text-editor-text text-xs">Annulla</button>
                            <button @click="saveSettings" class="px-4 py-2 bg-editor-keyword text-white rounded text-xs hover:bg-editor-keyword/80">Salva</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <script type="module">
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
            import { 
                getAuth, 
                GoogleAuthProvider, 
                signInWithPopup, 
                sendSignInLinkToEmail,
                isSignInWithEmailLink,
                signInWithEmailLink,
                onAuthStateChanged,
                signOut 
            } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
            import { 
                getFirestore, 
                doc, 
                setDoc, 
                getDoc,
                onSnapshot 
            } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

            const firebaseConfig = {
                apiKey: "AIzaSyApyTE7tGRfYulUQ7d9HM822NxvlmeI5_s",
                authDomain: "todo-auth-ce530.firebaseapp.com",
                projectId: "todo-auth-ce530",
                storageBucket: "todo-auth-ce530.firebasestorage.app",
                messagingSenderId: "711261099526",
                appId: "1:711261099526:web:187b4a46303fcbc3b89587"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const googleProvider = new GoogleAuthProvider();

            window.firebaseAuth = auth;
            window.firebaseDb = db;
            window.googleProvider = googleProvider;
            window.signInWithPopup = signInWithPopup;
            window.sendSignInLinkToEmail = sendSignInLinkToEmail;
            window.isSignInWithEmailLink = isSignInWithEmailLink;
            window.signInWithEmailLink = signInWithEmailLink;
            window.onAuthStateChanged = onAuthStateChanged;
            window.signOut = signOut;
            window.doc = doc;
            window.setDoc = setDoc;
            window.getDoc = getDoc;
            window.onSnapshot = onSnapshot;

            window.firebaseReady = true;
            window.dispatchEvent(new Event('firebase-ready'));
        </script>

        <script>
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('SW registered'))
                    .catch((err) => console.log('SW failed:', err));
            }

            const { createApp, ref, reactive, computed, onMounted } = Vue;

            const initApp = () => {
                createApp({
                    setup() {
                        const user = ref(null);
                        const guestMode = ref(false);
                        const loading = ref(true);
                        const syncing = ref(false);
                        const authLoading = ref(false);
                        const authError = ref('');
                        const email = ref('');
                        const emailSent = ref(false);
                        const days = ref([]);
                        const notes = ref([]);
                        const fileInput = ref(null);
                        const aiLoading = ref(false);
                        const openaiKey = ref(localStorage.getItem('openai_api_key') || '');
                        let unsubscribe = null;

                        const detailsModal = reactive({
                            show: false,
                            dayIndex: null,
                            taskIndex: null,
                            task: null,
                            details: ''
                        });

                        const settingsModal = reactive({
                            show: false,
                            apiKey: openaiKey.value
                        });

                        const currentDateTime = computed(() => {
                            const now = new Date();
                            return now.toLocaleDateString('it-IT') + ' ' + now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                        });

                        const totalPending = computed(() => {
                            return days.value.reduce((acc, day) => acc + day.tasks.filter(t => !t.done && t.text.trim()).length, 0);
                        });

                        const totalLines = computed(() => {
                            let count = 0;
                            days.value.forEach(day => {
                                count += 1 + day.tasks.length + 2;
                            });
                            count += 1 + notes.value.length + 1;
                            return Math.max(count, 20);
                        });

                        const formatDate = (date) => {
                            const d = date.getDate().toString().padStart(2, '0');
                            const m = (date.getMonth() + 1).toString().padStart(2, '0');
                            return `${d}/${m}`;
                        };

                        const parseDate = (dateStr) => {
                            const [d, m] = dateStr.split('/').map(Number);
                            const year = new Date().getFullYear();
                            const currentMonth = new Date().getMonth() + 1;
                            const adjustedYear = m > currentMonth + 1 ? year - 1 : year;
                            return new Date(adjustedYear, m - 1, d);
                        };

                        const sortDays = () => {
                            days.value.sort((a, b) => parseDate(b.date) - parseDate(a.date));
                        };

                        const enterGuestMode = () => {
                            guestMode.value = true;
                            loading.value = false;
                        };

                        const exitGuestMode = () => {
                            guestMode.value = false;
                            days.value = [];
                            notes.value = [];
                        };

                        const loginWithGoogle = async () => {
                            authLoading.value = true;
                            authError.value = '';
                            try {
                                await window.signInWithPopup(window.firebaseAuth, window.googleProvider);
                                guestMode.value = false;
                            } catch (error) {
                                console.error(error);
                                if (error.code === 'auth/popup-closed-by-user') {
                                    authError.value = '';
                                } else if (error.code === 'auth/unauthorized-domain') {
                                    authError.value = 'Dominio non autorizzato. Aggiungi questo dominio in Firebase Console > Authentication > Settings > Authorized domains';
                                } else {
                                    authError.value = 'Errore durante il login con Google';
                                }
                            }
                            authLoading.value = false;
                        };

                        const sendEmailLink = async () => {
                            if (!email.value) return;
                            authLoading.value = true;
                            authError.value = '';
                            
                            const actionCodeSettings = {
                                url: window.location.href,
                                handleCodeInApp: true,
                            };
                            
                            try {
                                await window.sendSignInLinkToEmail(window.firebaseAuth, email.value, actionCodeSettings);
                                window.localStorage.setItem('emailForSignIn', email.value);
                                emailSent.value = true;
                            } catch (error) {
                                console.error(error);
                                authError.value = 'Errore nell\'invio del link';
                            }
                            authLoading.value = false;
                        };

                        const checkEmailLink = async () => {
                            if (window.isSignInWithEmailLink(window.firebaseAuth, window.location.href)) {
                                let emailForSignIn = window.localStorage.getItem('emailForSignIn');
                                if (!emailForSignIn) {
                                    emailForSignIn = window.prompt('Inserisci la tua email per conferma:');
                                }
                                try {
                                    await window.signInWithEmailLink(window.firebaseAuth, emailForSignIn, window.location.href);
                                    window.localStorage.removeItem('emailForSignIn');
                                    window.history.replaceState(null, '', window.location.pathname);
                                } catch (error) {
                                    console.error(error);
                                    authError.value = 'Link non valido o scaduto';
                                }
                            }
                        };

                        const logout = async () => {
                            if (unsubscribe) unsubscribe();
                            await window.signOut(window.firebaseAuth);
                            days.value = [];
                            notes.value = [];
                        };

                        const save = async () => {
                            if (guestMode.value || !user.value) return;
                            syncing.value = true;
                            try {
                                await window.setDoc(window.doc(window.firebaseDb, 'users', user.value.uid), {
                                    days: days.value,
                                    notes: notes.value,
                                    updatedAt: new Date().toISOString()
                                });
                            } catch (error) {
                                console.error('Errore salvataggio:', error);
                            }
                            syncing.value = false;
                        };

                        const loadData = async () => {
                            if (!user.value) return;
                            
                            unsubscribe = window.onSnapshot(
                                window.doc(window.firebaseDb, 'users', user.value.uid),
                                (docSnap) => {
                                    if (docSnap.exists()) {
                                        const data = docSnap.data();
                                        days.value = data.days || [];
                                        notes.value = data.notes || [];
                                        sortDays();
                                    }
                                }
                            );
                        };

                        const addToday = () => {
                            const today = formatDate(new Date());
                            if (!days.value.find(d => d.date === today)) {
                                days.value.unshift({ date: today, tasks: [] });
                                sortDays();
                                save();
                            }
                        };

                        const addTask = (dayIndex, event) => {
                            const text = event.target.value.trim();
                            if (text) {
                                days.value[dayIndex].tasks.push({ text, done: false, details: '' });
                                event.target.value = '';
                                save();
                            }
                        };

                        const toggleTask = (dayIndex, taskIndex) => {
                            days.value[dayIndex].tasks[taskIndex].done = !days.value[dayIndex].tasks[taskIndex].done;
                            save();
                        };

                        const removeTask = (dayIndex, taskIndex) => {
                            days.value[dayIndex].tasks.splice(taskIndex, 1);
                            save();
                        };

                        const removeDay = (dayIndex) => {
                            if (confirm('Eliminare questo giorno?')) {
                                days.value.splice(dayIndex, 1);
                                save();
                            }
                        };

                        const openDetails = (dayIndex, taskIndex) => {
                            const task = days.value[dayIndex].tasks[taskIndex];
                            detailsModal.show = true;
                            detailsModal.dayIndex = dayIndex;
                            detailsModal.taskIndex = taskIndex;
                            detailsModal.task = task;
                            detailsModal.details = task.details || '';
                        };

                        const closeDetails = () => {
                            detailsModal.show = false;
                            detailsModal.dayIndex = null;
                            detailsModal.taskIndex = null;
                            detailsModal.task = null;
                            detailsModal.details = '';
                        };

                        const saveDetails = () => {
                            if (detailsModal.dayIndex !== null && detailsModal.taskIndex !== null) {
                                days.value[detailsModal.dayIndex].tasks[detailsModal.taskIndex].details = detailsModal.details;
                                save();
                            }
                            closeDetails();
                        };

                        const saveSettings = () => {
                            openaiKey.value = settingsModal.apiKey;
                            localStorage.setItem('openai_api_key', settingsModal.apiKey);
                            settingsModal.show = false;
                        };

                        const generateWithAI = async () => {
                            if (!detailsModal.task || !openaiKey.value) return;
                            
                            aiLoading.value = true;
                            const taskTitle = detailsModal.task.text;
                            const existingDetails = detailsModal.details;

                            let prompt = '';
                            if (existingDetails.trim()) {
                                prompt = `Riscrivi e migliora questa descrizione di una task in modo chiaro e conciso (max 2-3 righe).\n\nTitolo task: ${taskTitle}\nDescrizione attuale: ${existingDetails}\n\nRispondi solo con la nuova descrizione, senza prefissi.`;
                            } else {
                                prompt = `Genera una breve descrizione (max 2-3 righe) per questa task, spiegando cosa fare in modo chiaro e pratico.\n\nTask: ${taskTitle}\n\nRispondi solo con la descrizione, senza prefissi.`;
                            }

                            try {
                                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${openaiKey.value}`
                                    },
                                    body: JSON.stringify({
                                        model: 'gpt-3.5-turbo',
                                        messages: [{ role: 'user', content: prompt }],
                                        max_tokens: 150,
                                        temperature: 0.7
                                    })
                                });

                                if (!response.ok) {
                                    const err = await response.json();
                                    throw new Error(err.error?.message || 'errore api');
                                }

                                const data = await response.json();
                                if (data.choices && data.choices[0]) {
                                    detailsModal.details = data.choices[0].message.content.trim();
                                }
                            } catch (error) {
                                console.error('errore ai:', error);
                                alert('Errore: ' + error.message);
                            }
                            
                            aiLoading.value = false;
                        };

                        const carryOverTasks = () => {
                            const today = formatDate(new Date());
                            let todayDay = days.value.find(d => d.date === today);
                            
                            if (!todayDay) {
                                days.value.unshift({ date: today, tasks: [] });
                                sortDays();
                                todayDay = days.value.find(d => d.date === today);
                            }

                            let carried = 0;
                            days.value.forEach((day) => {
                                if (day.date !== today) {
                                    const pending = day.tasks.filter(t => !t.done && t.text.trim());
                                    pending.forEach(t => {
                                        if (!todayDay.tasks.find(tt => tt.text === t.text)) {
                                            todayDay.tasks.push({ ...t });
                                            carried++;
                                        }
                                    });
                                }
                            });

                            alert(carried > 0 ? `${carried} task portati a oggi` : 'Nessun task pendente');
                            save();
                        };

                        const addNote = (event) => {
                            const text = event.target.value.trim();
                            if (text) {
                                notes.value.unshift(text);
                                event.target.value = '';
                                save();
                            }
                        };

                        const removeNote = (index) => {
                            notes.value.splice(index, 1);
                            save();
                        };

                        const exportData = () => {
                            const data = JSON.stringify({ days: days.value, notes: notes.value }, null, 2);
                            const blob = new Blob([data], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `tasks-${formatDate(new Date()).replace('/', '-')}.json`;
                            a.click();
                            URL.revokeObjectURL(url);
                        };

                        const importData = () => fileInput.value.click();

                        const handleImport = (event) => {
                            const file = event.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    try {
                                        const data = JSON.parse(e.target.result);
                                        if (data.days) days.value = data.days;
                                        if (data.notes) notes.value = data.notes;
                                        sortDays();
                                        save();
                                        alert('Import completato');
                                    } catch (err) {
                                        alert('Errore nel file JSON');
                                    }
                                };
                                reader.readAsText(file);
                            }
                            event.target.value = '';
                        };

                        onMounted(async () => {
                            await checkEmailLink();
                            window.onAuthStateChanged(window.firebaseAuth, async (firebaseUser) => {
                                user.value = firebaseUser;
                                loading.value = false;
                                
                                if (firebaseUser) {
                                    guestMode.value = false;
                                    await loadData();
                                }
                            });
                        });

                        return {
                            user, guestMode, loading, syncing, authLoading, authError, email, emailSent,
                            days, notes, currentDateTime, totalPending, totalLines, fileInput, detailsModal, settingsModal, aiLoading, openaiKey,
                            enterGuestMode, exitGuestMode, loginWithGoogle, sendEmailLink, logout, save,
                            addToday, addTask, toggleTask, removeTask, removeDay, carryOverTasks,
                            addNote, removeNote, exportData, importData, handleImport,
                            openDetails, closeDetails, saveDetails, saveSettings, generateWithAI
                        };
                    }
                }).mount('#app');
            };

            if (window.firebaseReady) {
                initApp();
            } else {
                window.addEventListener('firebase-ready', initApp);
            }
        </script>
    </body>
</html>